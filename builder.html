<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sumo Shapes Stage Builder</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <style>

    button {
      margin: 5px;
    }

    body{
        overflow: hidden;
        background-color: #87CEEB;
        touch-action: manipulation;
    }

    *{
        outline: none;
        user-select: none !important;
        color: white;
        font-family: Poppins, sans-serif;
    }

    @media (max-width: 768px) {
        button {
            font-size: 0.8rem;
        }
        #c{
            width: 90% !important;
        }
    }

    .center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 50%;
    text-align: center;
    background-color: #1a1a2e;
    padding: 10px;
    border-radius: 10px;
    z-index: 100000;
  }


  @media (max-width: 768px) {
    .center {
        width: 90%;
    }
  }

  input, select, button{
    padding: 5px;
    border: none;
    border-radius: 5px;
    margin: 8px;
    text-align: center;
    background-color: #1a1a2e;
  }

  input, select{
    border: 1px solid #0f3460;

  }

#start{
    display: none;
}

.floor {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 100vw; /* Ensures the width doesn't exceed the viewport */
    height: 30px;
    background-color: #333;
    color: white;
    text-align: center;
    padding: 10px;
    z-index: 100000;
    box-sizing: border-box; /* Ensures padding is included in the width and height calculations */
}


.controls{
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 1000;
    background-color: #16213e;
    width: fit-content;
    z-index: 10000000;
    border-bottom-left-radius: 10px;
    resize: both !important;
}

#stage{
    position: absolute;
    top: 0;
    right: 0;
    width: 100%;
    height: 100%;
    background-color: #87CEEB;
    z-index: 0;
    background-position: center;
    background-size: cover;

}
.setting {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.sgroup {
    background-color: #16213e;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 5px;
}

.save-button {
    display: block;
    margin: 0 auto;
    padding: 10px 20px;
    background-color: #4CAF50;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    width: 100%;
}

.save-button:hover {
    background-color: #3e8e41;
}

button{
    cursor: pointer;
}

.controls button{
    background: none !important;
}

#platformPalette {
    display: none;
    padding: 10px;
    margin: 0;
    width: max-content !important;
    background-color: #0f3460;
}

#platformPalette * {
    width: initial;
    border: none;
    background: none;
    padding: 5px;
    margin: 0;
    cursor: pointer;
}

.palette-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0px !important;
    width: 100%;
}

#platformPaletteLbl {
    color: gray !important;
    font-size: 0.68rem;
}

#platformPaletteClose {
    color: red !important;
    font-size: 1.2rem;
}

.palette-icons {
    padding-top: 1px !important;
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 10px;
}

.palette-inputs {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

#platformPalette input {
    display: none;
    border: 1px solid #0f3460;
    width: 90%;
    background-color: #1a1a2e;
}
  </style>
</head>

<div class="controls draggable">
    <button id="backb" title="Exit Editor" style="color: #f44336;" class="material-symbols-outlined">close</button>
    <button id="editb" title="Settings" class="material-symbols-outlined">settings</button>
    <button id="saveb" title="Export Stage" class="material-symbols-outlined">publish</button>
    <button id="clearb" title="Clear Stage" class="material-symbols-outlined">delete</button>
    <button title="Upload Stage" onclick="document.getElementById('fileInput').click();" class="material-symbols-outlined">upload</button>
    <button title="Play Stage" onclick="play()" class="material-symbols-outlined">play_arrow</button>
</div>
<input type="file" id="fileInput" style="visibility: hidden;" onchange="loadStage()" accept=".json">

<div id="platformPalette" class="center draggable">
    <div class="palette-header">
        <i id="platformPaletteLbl">Platform Tools</i>
        <i id="platformPaletteClose" class="material-symbols-outlined" title="Close" onclick="document.getElementById('platformPalette').style.display = 'none'; selectedPlatform = ''">close</i>
    </div>
    <div class="palette-icons">
        <i class="material-symbols-outlined" title="Color" id="paletteColor" onclick="setTool('Color')">brush</i>
        <i class="material-symbols-outlined" title="Width" id="paletteWidth" onclick="setTool('Width')">width</i>
        <i class="material-symbols-outlined" title="Height" id="paletteHeight" onclick="setTool('Height')">height</i>
        <i class="material-symbols-outlined" title="Rotate" id="paletteRot" onclick="setTool('Rot')">rotate_right</i>
        <i class="material-symbols-outlined" style="display: none;" title="Delete Platform" id="paletteDel" onclick="selectedPlatform && stage.removeChild(selectedPlatform); data.platforms = data.platforms.filter(p => p.id !== selectedPlatform.id); document.getElementById('platformPalette').style.display = 'none'; selectedPlatform = '';">delete</i>
    </div>
    <div class="palette-inputs">
        <input type="text" id="platformColor" value="#000000">
        <input id="platformWidth" value="window">
        <input id="platformHeight" value="20">
        <input type="number" id="platformRot" value="0">
    </div>
</div>


<div id="customize" class="center" style="width: 50%;display: none;height: 75%;overflow: scroll;">
    <div class="sgroup">
        <h2>Customize Platforms</h2>
        To customize platforms, right click on the Stage or platform and select the desired tool from the palette. <br>
    </div>
<div class="sgroup">
    <h2>Background</h2>
    <div class="setting">
        <label for="bg_type">Background Type</label>
        <select id="bg_type">
            <option value="color">Color</option>
            <option value="image">Image</option>
        </select>
    </div>
    <div class="setting">
        <label for="bg_color">Background Color</label>
        <input type="text" id="bg_color" value="#87CEEB">
    </div>
    <div class="setting">
        <label for="bg_image">Background Image</label>
        <input type="url" id="bg_image" value="https://picsum.photos/800/600">
    </div>
    <div class="setting">
        <label for="bg_image">Floor Width</label>
        <input id="floorWidth" value="window">
    </div>
</div>
<div class="sgroup">
    <h2>Version</h2>
    <p>Require a specific version to play this stage. For example, if you use dynamic platform values, you must require version 1.0.0 or higher. Your current version is <span id="v"></span></p>
    <div class="setting">
        <label>Required Version</label>
        <input id="reqv" type="text">
    </div>
</div>
<div class="sgroup">
    <h2>Help</h2>
    <div class="setting">
        <label for="playerColor">Left Click</label>
        <label for="playerColor">Create Platform</label>
    </div>
    <div class="setting">
        <label for="playerColor">Right Click</label>
        <label for="playerColor">Edit or Delete Platform</label>
    </div>
    <div class="setting">
        <label for="playerColor">Click and Drag</label>
        <label for="playerColor">Move Platform</label>
    </div>
    <div class="setting">
        <label for="playerColor">Valid CSS Size Types</label>
        <label for="playerColor">px, %, vw, vh, vmin, vmax, em, rem</label>
    </div>
    <div class="setting">
    <label>Publish Stage</label>
    <label><a onclick="window.electron.publishStage()" style="color: #007bff; cursor: pointer;padding-top: 1rem;text-align: center;text-decoration: underline;">Learn More</a></label>
    </div>
</div>
<button id="closeCust" class="save-button">Close</button><br>
<button id="resetSaved" class="save-button" style="background-color: red;">Reset to Default</button>
</div>


<div id="stage"></div>

<div style="margin: auto;" class="floor"></div>


<script>
const stage = document.getElementById('stage');

const { v } = window.electron.getIP();
document.getElementById('reqv').placeholder = v;
document.getElementById('v').textContent = v;

let tool = 'color';

let selectedPlatform;


const showPalleteForSelected = (e, platform) => {
selectedPlatform = platform;
document.getElementById('platformPalette').style.display = 'block';

let offset = w + 100

if(e.clientX + offset + 200 > window.innerWidth) offset = -offset;

document.getElementById('platformPalette').style.left = e.clientX + offset + 'px';
document.getElementById('platformPalette').style.top = e.clientY + 'px';
document.getElementById('paletteDel').style.display = 'inline-block';

const savedPlatform = data.platforms.find(p => p.id === platform.id);
document.getElementById('platformColor').value = savedPlatform.color;
document.getElementById('platformWidth').value = savedPlatform.width;
document.getElementById('platformHeight').value = savedPlatform.height;
document.getElementById('platformRot').value = savedPlatform.rotation;

document.getElementById('platformPaletteLbl').textContent = 'EDIT PLATFORM';
}


function setTool(t) {
    tool = t;
    document.querySelectorAll('#platformPalette input').forEach(input => {
        input.style.display = 'none';
    });

    document.querySelectorAll('#platformPalette i').forEach(i => {
        i.style.color = 'white';
    });

    document.getElementById(`platform${t}`).style.display = 'block';
    document.getElementById(`palette${t}`).style.color = '#f44336';

    localStorage.setItem('tool', t);
}

setTool(localStorage.tool || 'Color');

let saved = false;
const data = {
    platforms: [],
    backgroundType: 'color',
    backgroundColor: '#87CEEB',
    backgroundImage: '',
    platformWidth: localStorage.getItem('floorWidth') || 'window'
}
let background = '#87CEEB';

let h = localStorage.getItem('platformHeight') || 20;
let w = localStorage.getItem('platformWidth') || 100;
let bg = localStorage.getItem('platformColor') || 'black';
let rot = localStorage.getItem('platformRotation') || 0;
let fw = localStorage.getItem('floorWidth') || 'window';

document.getElementById('platformColor').value = bg;
document.getElementById('platformWidth').value = w;
document.getElementById('platformHeight').value = h;
document.getElementById('platformRot').value = rot;
document.getElementById('floorWidth').value = fw;

document.getElementById('floorWidth').addEventListener('change', (e) => {
    fw = e.target.value;
    localStorage.setItem('floorWidth', e.target.value);
    data.platformWidth = e.target.value;
    document.querySelector('.floor').style.width = e.target.value == 'window' ? '100%' : e.target.value + 'px';
});

document.querySelector('.floor').style.width = fw == 'window' ? '100%' : fw + 'px';

let isDragging = false;

document.getElementById('reqv').addEventListener('input', (e) => {
    data.requiredVersion = e.target.value;
});

document.getElementById('stage').addEventListener('click', (e) => {
if(document.getElementById('platformPalette').style.display != 'none') {
    selectedPlatform = '';
    return document.getElementById('platformPalette').style.display = 'none';
}
    if (e.target !== stage) return;

    const id = Math.random().toString(36).substring(7);
    const platform = document.createElement('div');
    platform.style.position = 'absolute';
    platform.style.left = e.clientX + 'px';
    platform.style.top = e.clientY + 'px';
    console.log(isNaN(parseInt(w)) || /[a-zA-Z%]/.test(w) ? w : `${w}px`);
    platform.style.width = `${isNaN(parseInt(w)) || /[a-zA-Z%]/.test(w) ? w : `${w}px`}`;
    platform.style.height = `${isNaN(parseInt(h)) || /[a-zA-Z%]/.test(h) ? h : `${h}px`}`;
    platform.style.backgroundColor = bg;
    platform.style.borderRadius = '5px';
    platform.style.zIndex = 1;
    platform.id = id;
    platform.style.transform = `rotate(${rot}deg)`;

    platform.oncontextmenu = (e) => {
        e.preventDefault();
        showPalleteForSelected(e, platform);
    };

    let offsetX, offsetY;

    platform.addEventListener('mousedown', (e) => {
        e.preventDefault();
        isDragging = true;
        offsetX = e.clientX - platform.offsetLeft;
        offsetY = e.clientY - platform.offsetTop;

        function onMouseMove(e) {
            if (!isDragging) return;
            platform.style.left = `${e.clientX - offsetX}px`;
            platform.style.top = `${e.clientY - offsetY}px`;

            const platformData = data.platforms.find(p => p.id === id);
            if (platformData) {
                platformData.x = e.clientX - offsetX;
                platformData.y = e.clientY - offsetY;
            }
        }

        function onMouseUp() {
            isDragging = false;
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    });

    stage.appendChild(platform);
    data.platforms.push({
        x: e.clientX,
        y: e.clientY,
        width: w,
        height: h,
        color: bg,
        rotation: rot,
        id
    });
});


document.getElementById('backb').addEventListener('click', () => {
    if(data.platforms.length === 0 || saved) return window.electron.menu()
    if(!confirm('You have unsaved changes. Are you sure you want to exit?')) return;
    window.electron.menu()
});

document.getElementById('resetSaved').addEventListener('click', () => {
    if(!confirm('Are you sure you want to reset your settings? This will clear the stage.')) return;
    localStorage.clear();
    location.reload()
});

document.getElementById('editb').addEventListener('click', () => {
document.getElementById('customize').style.display = document.getElementById('customize').style.display === 'none' ? 'block' : 'none';
});

document.getElementById('saveb').addEventListener('click', () => {
    saved = true;
    data.platforms.forEach(platform => {
        platform.rotation = parseInt(platform.rotation);
    });
    window.electron.save(data);
});

document.getElementById('clearb').addEventListener('click', () => {
    if(!confirm('Are you sure you want to clear the stage?')) return;
    data.platforms.forEach(platform => {
        stage.removeChild(document.getElementById(platform.id));
    });
    data.platforms.length = 0;
});

document.getElementById('closeCust').addEventListener('click', () => {
    document.getElementById('customize').style.display = 'none';
});

document.getElementById('platformColor').addEventListener('input', (e) => {
    localStorage.setItem('platformColor', e.target.value);
    bg = e.target.value;
});

document.getElementById('platformWidth').addEventListener('input', (e) => {
    localStorage.setItem('platformWidth', e.target.value);
    w = e.target.value;
});

document.getElementById('platformHeight').addEventListener('input', (e) => {
    localStorage.setItem('platformHeight', e.target.value);
    h = e.target.value;
});

document.getElementById('platformRot').addEventListener('input', (e) => {
    localStorage.setItem('platformRotation', e.target.value);
    rot = e.target.value;
});

document.getElementById('bg_type').addEventListener('change', (e) => {
   if(e.target.value == 'color'){
       document.getElementById('stage').style.backgroundImage = 'none';
       document.getElementById('stage').style.backgroundColor = e.target.value;
   }else{
    document.getElementById('stage').style.backgroundImage = `url(${document.getElementById('bg_image').value})`;
   }
    data.backgroundType = e.target.value;
});

document.getElementById('bg_color').addEventListener('input', (e) => {
    if(document.getElementById('bg_type').value === 'color'){
        document.getElementById('stage').style.backgroundColor = e.target.value;
    }
    data.backgroundColor = e.target.value;
});

document.getElementById('bg_image').addEventListener('input', (e) => {
    if(document.getElementById('bg_type').value === 'image'){
        document.getElementById('stage').style.backgroundImage = `url(${e.target.value})`;
    }
    data.backgroundImage = e.target.value;
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        document.getElementById('customize').style.display = 'none';
    }
});

const addUnit = (value, defaultUnit = 'px') => {
        const validUnits = /(px|%|vw|vh|vmin|vmax|em|rem)$/;
        return validUnits.test(value) ? value : `${value}${defaultUnit}`;
    };

function loadStage() {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const _data = JSON.parse(e.target.result);
            const stage = document.getElementById('stage');
            stage.innerHTML = '';
            data.platforms = _data.platforms || [];
            
            if (_data.backgroundType === 'color') {
                stage.style.backgroundColor = _data.backgroundColor;
                stage.style.backgroundImage = '';
            } else if (_data.backgroundType === 'image') {
                stage.style.backgroundImage = `url(${_data.backgroundImage})`;
                stage.style.backgroundColor = '';
            }

            document.getElementById('bg_type').value = _data.backgroundType;
            document.getElementById('bg_color').value = _data.backgroundColor;
            document.getElementById('bg_image').value = _data.backgroundImage;
            document.getElementById('floorWidth').value = _data.platformWidth;
            



            _data.platforms.forEach(platform => {
                const { x, y, width, height, color, rotation } = platform;
     const platformElement = document.createElement('div');
    platformElement.style.position = 'absolute';
    platformElement.style.left = addUnit(x);
    platformElement.style.top = addUnit(y);
    platformElement.style.width = addUnit(width, 'px'); 
    platformElement.style.height = addUnit(height, 'px');
    platformElement.style.backgroundColor = color;
    platformElement.id = platform.id;
    platformElement.style.transform = `rotate(${rotation}deg)`;
    
    document.body.appendChild(platformElement);

                platformElement.oncontextmenu = (e) => {
                    e.preventDefault();
                 showPalleteForSelected(e, platformElement);
                };

                let isDragging = false;
                let offsetX, offsetY;

                platformElement.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    isDragging = true;
                    offsetX = e.clientX - platformElement.offsetLeft;
                    offsetY = e.clientY - platformElement.offsetTop;

                    function onMouseMove(e) {
                        if (!isDragging) return;
                        platformElement.style.left = `${e.clientX - offsetX}px`;
                        platformElement.style.top = `${e.clientY - offsetY}px`;

                        // Update position in data.platforms
                        const platformData = data.platforms.find(p => p.id === platform.id);
                        if (platformData) {
                            platformData.x = e.clientX - offsetX;
                            platformData.y = e.clientY - offsetY;
                        }
                    }

                    function onMouseUp() {
                        isDragging = false;
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    }

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });

                stage.appendChild(platformElement);
            });
        };
        reader.readAsText(file);
    } else {
        alert('Please select a file.');
    }
}

const play = () => {
    if(saved) return window.electron.playStageObj(data);
    if(!confirm('This will not save your stage. Make sure you do that before playing.')) return;
    window.electron.playStageObj(data);
}


const draggables = document.querySelectorAll('.draggable');
const resizerMargin = 10;

draggables.forEach(draggable => { 
    draggable.addEventListener('mousedown', (event) => {
        let rect = draggable.getBoundingClientRect();
        
        if (event.clientX > rect.right - resizerMargin || event.clientY > rect.bottom - resizerMargin) {
            return;
        }

        let shiftX = event.clientX - rect.left;
        let shiftY = event.clientY - rect.top;

        function moveAt(pageX, pageY) {
            draggable.style.left = pageX - shiftX + 'px';
            draggable.style.top = pageY - shiftY + 'px';
            draggable.style.borderRadius = '10px';
        }

        function onMouseMove(event) {
            moveAt(event.pageX, event.pageY);
        }

        function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            draggable.classList.remove('no-select');
            localStorage.setItem('controlsPos', JSON.stringify({ x: draggable.style.left, y: draggable.style.top }));
        }

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
        draggable.classList.add('no-select'); 
    });

    draggable.ondragstart = () => false;
});

if (localStorage.getItem('controlsPos')) {
    const { x, y } = JSON.parse(localStorage.getItem('controlsPos'));
    const defaultX = document.querySelector('.controls').style.left; 
    const defaultY = document.querySelector('.controls').style.top; 

    if (parseInt(x) > defaultX + 15 && parseInt(y) > defaultY + 15) {
        document.querySelector('.controls').style.borderRadius = '10px';
    }
    document.querySelectorAll('.draggable').forEach(draggable => {
        draggable.style.left = x;
        draggable.style.top = y;
    });
}

document.head.insertAdjacentHTML('beforeend', `<style>
    .no-select {
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }
</style>`);

document.addEventListener('keydown', (e) => {
    if (e.key === 'r' && !e.ctrlKey && !e.metaKey) {
        document.querySelectorAll('.draggable').forEach(draggable => {
            draggable.style.top = '0';
            draggable.style.left = '';
            draggable.style.right = '0';
            draggable.style.borderRadius = '0px';
            draggable.style.borderBottomLeftRadius = '10px';
            localStorage.removeItem('controlsPos');
        });
    }
});

document.querySelectorAll('.draggable').forEach(draggable => {
            draggable.style.top = '0';
            draggable.style.left = '';
            draggable.style.right = '0';
})


document.body.oncontextmenu = (e) => {
    if (e.shiftKey) return;
    e.preventDefault();
    if (e.target == stage) {
       document.getElementById('platformPalette').style.display = 'block';

       let offset = 95

        if(e.clientX + offset + 200 > window.innerWidth) offset = -offset;
       
         document.getElementById('platformPalette').style.left = e.clientX + offset + 'px';
            document.getElementById('platformPalette').style.top = e.clientY + 'px';
            document.getElementById('paletteDel').style.display = 'none';

            document.getElementById('platformColor').value = bg;
            document.getElementById('platformWidth').value = w;
            document.getElementById('platformHeight').value = h;
            document.getElementById('platformRot').value = rot;

            document.getElementById('platformPaletteLbl').textContent = 'NEW PLATFORMS';
    }
}


document.querySelectorAll('#platformPalette input').forEach(input => {
input.addEventListener('change', (e) => {
if(!selectedPlatform) return;
let type = input.id.replace('platform', '').toLowerCase();
let val = e.target.value.toLowerCase();
if(type == 'color') type = 'backgroundColor';
if(type == 'width') val = addUnit(val, 'px');
if(type == 'height') val = addUnit(val, 'px');
if(type == 'rot') {
    type = 'transform';
    val = `rotate(${val}deg)`;
}
const savedPlatform = data.platforms.find(p => p.id === selectedPlatform.id);
savedPlatform[type == 'transform' ? 'rotation' : type] = type == 'transform' ? parseInt(e.target.value) : val;
document.getElementById(selectedPlatform.id).style[type] = val;
console.log('Set', type, 'to', val);
})
});

</script>