<style>
  body {
    margin: 0;
    overflow: hidden;
    font-family: Arial, Helvetica, sans-serif;
  }

  #loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 24px;
  }

  .spinner {
    border: 4px solid rgba(255, 255, 255, 0.1);
    border-left-color: #fff;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
</style>


<div id="loading">
  <div class="spinner"></div>
</div>

<script>
const stage = new URLSearchParams(window.location.search).get('stage');


if(!stage) {
document.body.innerHTML = '<div id="loading"><p>Please provide a stage in the URL: <code>/preview?stage=USERNAME/REPOSITORY</code></p></div>';
}else{
  const u = stage.split('/')[0];
  const r = stage.split('/')[1];
  if(!u || !r) {
    document.body.innerHTML = '<div id="loading"><p>Please provide a valid stage in the URL: <code>/preview?stage=USERNAME/REPOSITORY</code></p></div>';
  }else{ 
  document.title = `Preview ${r.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')} by ${u}`;
  document.addEventListener('DOMContentLoaded', async () => {
    setTimeout(async () => {
      try {
        const response = await fetch(`https://raw.githubusercontent.com/${u}/${r}/main/index.json`);
        if (!response.ok) {
          document.body.innerHTML = '<div id="loading"><p>Error loading the stage. Please make sure the repository exists and the stage is correctly configured.</p></div>';
          return;
        }
        const data = await response.json();
        document.body.innerHTML = '';
        const { platforms, backgroundType, backgroundColor, backgroundImage } = data;
        document.body.style.margin = 0;
        document.body.style.overflow = 'hidden';

        const addUnit = (value, defaultUnit = 'px') => {
          const validUnits = /(px|%|vw|vh|vmin|vmax|em|rem)$/;
          return validUnits.test(value) ? value : `${value}${defaultUnit}`;
        };

        platforms.forEach(platform => {
          const { x, y, width, height, color, rotation } = platform;
          const platformElement = document.createElement('div');
          platformElement.style.left = addUnit(x);
          platformElement.style.top = addUnit(y);
          platformElement.style.width = addUnit(width); 
          platformElement.style.height = addUnit(height);
          platformElement.style.backgroundColor = color;
          platformElement.id = platform.id;
          platformElement.style.transform = `rotate(${rotation}deg)`;
          platformElement.style.position = 'absolute';
          document.body.appendChild(platformElement);
        });

        document.body.style.background = backgroundType == 'color' ? backgroundColor : `url(${backgroundImage}) no-repeat center center fixed`;
      } catch (error) {
        document.body.innerHTML = '<div id="loading"><p>Error loading the stage. Please make sure the repository exists and the stage is correctly configured.</p></div>';
      }
    }, 1000);
  });
}
}
</script>